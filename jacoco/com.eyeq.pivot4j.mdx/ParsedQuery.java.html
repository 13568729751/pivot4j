<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ParsedQuery.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Pivot4J</a> &gt; <a href="index.html" class="el_package">com.eyeq.pivot4j.mdx</a> &gt; <span class="el_source">ParsedQuery.java</span></div><h1>ParsedQuery.java</h1><pre class="source lang-java linenums">/*
 * ====================================================================
 * This software is subject to the terms of the Common Public License
 * Agreement, available at the following URL:
 *   http://www.opensource.org/licenses/cpl.html .
 * You must accept the terms of that agreement to use this software.
 * ====================================================================
 */
package com.eyeq.pivot4j.mdx;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.eyeq.pivot4j.PivotException;

/**
 * this is the result of parsing an MDX
 */
<span class="fc" id="L26">public class ParsedQuery implements Exp {</span>

	private static final long serialVersionUID = 8608792548174831908L;

<span class="fc" id="L30">	protected static Logger logger = LoggerFactory.getLogger(ParsedQuery.class);</span>

<span class="fc" id="L32">	List&lt;Formula&gt; formulas = new ArrayList&lt;Formula&gt;();</span>

<span class="fc" id="L34">	Map&lt;String, Parameter&gt; paraMap = new HashMap&lt;String, Parameter&gt;();</span>

	List&lt;QueryAxis&gt; axisDef;

	String cube;

<span class="fc" id="L40">	List&lt;CompoundId&gt; cellProps = new ArrayList&lt;CompoundId&gt;();</span>

<span class="fc" id="L42">	Exp slicer = null;</span>

	// TODO implement proper node for SAP variable expressions.
<span class="fc" id="L45">	List&lt;String&gt; sapVariables = new ArrayList&lt;String&gt;();</span>

<span class="fc" id="L47">	private QueryAxis[] axes = new QueryAxis[0];</span>

	/**
	 * called after parse to make things easier
	 */
	public void afterParse() throws PivotException {
<span class="pc bpc" id="L53" title="1 of 2 branches missed.">		if (axisDef != null) {</span>
<span class="fc" id="L54">			this.axes = (QueryAxis[]) axisDef.toArray(new QueryAxis[0]);</span>
<span class="fc" id="L55">			this.axisDef = null;</span>
		}
<span class="fc" id="L57">		collectParams();</span>
<span class="fc" id="L58">	}</span>

	/**
	 * 
	 * @return QueryAxis[]
	 */
	public QueryAxis[] getAxes() {
<span class="fc" id="L65">		return this.axes;</span>
	}

	/**
	 * 
	 * @param axes
	 */
	public void setAxes(QueryAxis[] axes) {
<span class="nc" id="L73">		this.axes = axes;</span>
<span class="nc" id="L74">	}</span>

	/**
	 * Returns the cube.
	 * 
	 * @return String
	 */
	public String getCube() {
		// remove enclosing brackets, if there
<span class="nc bnc" id="L83" title="All 4 branches missed.">		if (cube.charAt(0) == '[' &amp;&amp; cube.charAt(cube.length() - 1) == ']') {</span>
<span class="nc" id="L84">			return cube.substring(1, cube.length() - 1);</span>
		} else {
<span class="nc" id="L86">			return cube;</span>
		}
	}

	/**
	 * Sets the cube.
	 * 
	 * @param cube
	 *            The cube to set
	 */
	public void setCube(String cube) {
<span class="fc" id="L97">		this.cube = cube;</span>
<span class="fc" id="L98">	}</span>

	/**
	 * @return the sapVariables
	 */
	public List&lt;String&gt; getSapVariables() {
<span class="nc" id="L104">		return sapVariables;</span>
	}

	/**
	 * @param sapVariables
	 *            the sapVariables to set
	 */
	public void setSapVariables(List&lt;String&gt; sapVariables) {
<span class="nc" id="L112">		this.sapVariables = sapVariables;</span>
<span class="nc" id="L113">	}</span>

	/**
	 * get the formulas of this query
	 * 
	 * @return Formula[]
	 */
	public Formula[] getFormulas() {
<span class="nc" id="L121">		return formulas.toArray(new Formula[0]);</span>
	}

	public String toMdx() {
<span class="fc" id="L125">		StringBuffer mdx = new StringBuffer();</span>
		boolean isFollow;
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">		if (formulas.size() &gt; 0) {</span>
<span class="nc" id="L128">			mdx.append(&quot;WITH &quot;);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			for (Formula form : formulas) {</span>
<span class="nc" id="L130">				mdx.append(' ');</span>
<span class="nc" id="L131">				mdx.append(form.toMdx());</span>
			}
<span class="nc" id="L133">			mdx.append(' ');</span>
		}
<span class="fc" id="L135">		mdx.append(&quot;SELECT &quot;);</span>
<span class="fc" id="L136">		isFollow = false;</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">		for (int i = 0; i &lt; axes.length; i++) {</span>
<span class="fc" id="L138">			QueryAxis qa = axes[i];</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">			if (isFollow)</span>
<span class="fc" id="L140">				mdx.append(&quot;, &quot;);</span>
<span class="fc" id="L141">			isFollow = true;</span>
<span class="fc" id="L142">			mdx.append(qa.toMdx());</span>
		}
<span class="fc" id="L144">		mdx.append(&quot; FROM &quot;);</span>
<span class="fc" id="L145">		mdx.append(cube);</span>

<span class="fc bfc" id="L147" title="All 2 branches covered.">		if (slicer != null) {</span>
<span class="fc" id="L148">			mdx.append(&quot; WHERE &quot;);</span>
<span class="fc" id="L149">			mdx.append(slicer.toMdx());</span>
		}

		// add CELL PROPERTIES VALUE, FORMATTED_VALUE, ...
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">		if (cellProps.size() &gt; 0) {</span>
<span class="nc" id="L154">			mdx.append(&quot; CELL PROPERTIES VALUE, FORMATTED_VALUE&quot;);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">			for (CompoundId cid : cellProps) {</span>
<span class="nc" id="L156">				String str = cid.toMdx();</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">				if (str.equalsIgnoreCase(&quot;VALUE&quot;))</span>
<span class="nc" id="L158">					continue; // default</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">				if (str.equalsIgnoreCase(&quot;FORMATTED_VALUE&quot;))</span>
<span class="nc" id="L160">					continue; // default</span>
<span class="nc" id="L161">				mdx.append(&quot; ,&quot;);</span>
<span class="nc" id="L162">				mdx.append(str);</span>
			}
		}

<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if (!sapVariables.isEmpty()) {</span>
<span class="nc" id="L167">			mdx.append(&quot; SAP VARIABLES &quot;);</span>

<span class="nc" id="L169">			boolean first = true;</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">			for (Object sapVariable : sapVariables) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">				if (first) {</span>
<span class="nc" id="L173">					first = false;</span>
				} else {
<span class="nc" id="L175">					mdx.append(&quot;, &quot;);</span>
				}

<span class="nc" id="L178">				mdx.append(sapVariable);</span>
			}
		}

<span class="fc" id="L182">		return mdx.toString();</span>
	}

	public String toDrillMdx() {
<span class="nc" id="L186">		StringBuffer mdx = new StringBuffer();</span>
		boolean isFollow;
<span class="nc bnc" id="L188" title="All 2 branches missed.">		if (formulas.size() &gt; 0) {</span>
<span class="nc" id="L189">			mdx.append(&quot;WITH &quot;);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">			for (Formula form : formulas) {</span>
<span class="nc" id="L191">				mdx.append(' ');</span>
<span class="nc" id="L192">				mdx.append(form.toMdx());</span>
			}
<span class="nc" id="L194">			mdx.append(' ');</span>
		}
<span class="nc" id="L196">		mdx.append(&quot;DRILLTHROUGH SELECT &quot;);</span>

<span class="nc" id="L198">		isFollow = false;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">		for (int i = 0; i &lt; axes.length; i++) {</span>
<span class="nc" id="L200">			QueryAxis qa = axes[i];</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if (isFollow)</span>
<span class="nc" id="L202">				mdx.append(&quot;, &quot;);</span>
<span class="nc" id="L203">			isFollow = true;</span>
<span class="nc" id="L204">			mdx.append(qa.toMdx());</span>
		}
<span class="nc" id="L206">		mdx.append(&quot; FROM &quot;);</span>
<span class="nc" id="L207">		mdx.append(cube);</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (slicer != null) {</span>
<span class="nc" id="L210">			mdx.append(&quot; WHERE &quot;);</span>
<span class="nc" id="L211">			mdx.append(slicer.toMdx());</span>
		}

		// add CELL PROPERTIES VALUE, FORMATTED_VALUE, ...
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (cellProps.size() &gt; 0) {</span>
<span class="nc" id="L216">			mdx.append(&quot; CELL PROPERTIES VALUE, FORMATTED_VALUE&quot;);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">			for (CompoundId cid : cellProps) {</span>
<span class="nc" id="L218">				String str = cid.toMdx();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">				if (str.equalsIgnoreCase(&quot;VALUE&quot;))</span>
<span class="nc" id="L220">					continue; // default</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">				if (str.equalsIgnoreCase(&quot;FORMATTED_VALUE&quot;))</span>
<span class="nc" id="L222">					continue; // default</span>
<span class="nc" id="L223">				mdx.append(&quot; ,&quot;);</span>
<span class="nc" id="L224">				mdx.append(str);</span>
			}
		}

<span class="nc bnc" id="L228" title="All 2 branches missed.">		if (!sapVariables.isEmpty()) {</span>
<span class="nc" id="L229">			mdx.append(&quot; SAP VARIABLES &quot;);</span>

<span class="nc" id="L231">			boolean first = true;</span>

<span class="nc bnc" id="L233" title="All 2 branches missed.">			for (Object sapVariable : sapVariables) {</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">				if (first) {</span>
<span class="nc" id="L235">					first = false;</span>
				} else {
<span class="nc" id="L237">					mdx.append(&quot;, &quot;);</span>
				}

<span class="nc" id="L240">				mdx.append(sapVariable);</span>
			}
		}

<span class="nc" id="L244">		return mdx.toString();</span>
	}

	/**
	 * 
	 * @see java.lang.Object#clone()
	 */
	public ParsedQuery clone() {
<span class="nc" id="L252">		ParsedQuery cloned = new ParsedQuery();</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (!formulas.isEmpty()) {</span>
<span class="nc" id="L254">			List&lt;Formula&gt; clonedFormulas = new ArrayList&lt;Formula&gt;();</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">			for (Formula form : formulas) {</span>
<span class="nc" id="L256">				clonedFormulas.add((Formula) form.clone());</span>
			}
<span class="nc" id="L258">			cloned.formulas = clonedFormulas;</span>
		}
<span class="nc bnc" id="L260" title="All 2 branches missed.">		if (axes.length &gt; 0) {</span>
<span class="nc" id="L261">			QueryAxis[] clonedAxes = new QueryAxis[axes.length];</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">			for (int i = 0; i &lt; clonedAxes.length; i++) {</span>
<span class="nc" id="L263">				clonedAxes[i] = (QueryAxis) axes[i].clone();</span>
			}
<span class="nc" id="L265">			cloned.setAxes(clonedAxes);</span>
		}
<span class="nc bnc" id="L267" title="All 2 branches missed.">		if (slicer != null)</span>
<span class="nc" id="L268">			cloned.slicer = (Exp) this.slicer.clone();</span>

		// you need to wrap the cube in backets again!
		// Why does getCube remove the brackets?
<span class="nc" id="L272">		cloned.setCube(&quot;[&quot; + this.getCube() + &quot;]&quot;);</span>
<span class="nc" id="L273">		return cloned;</span>
	}

	/**
	 * @return sliecer exp
	 */
	public Exp getSlicer() {
<span class="nc" id="L280">		return slicer;</span>
	}

	/**
	 * set the slicer exp
	 * 
	 * @param exp
	 */
	public void setSlicer(Exp exp) {
<span class="fc" id="L289">		this.slicer = exp;</span>
<span class="fc" id="L290">	}</span>

	/**
	 * Collect Parameters and Parameter references
	 */
	private void collectParams() throws PivotException {
		// walk Formulas
<span class="fc" id="L297">		int iAxis = -2;</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">		for (Formula formula : formulas) {</span>
<span class="nc" id="L299">			walkTreeForParams(formula.getExp(), iAxis);</span>
			// dont forget the member properties
<span class="nc bnc" id="L301" title="All 2 branches missed.">			for (int i = 0; i &lt; formula.memberProperties.length; i++) {</span>
<span class="nc" id="L302">				walkTreeForParams(formula.memberProperties[i].getExp(), iAxis);</span>
			}
		}

		// walk axes
<span class="fc bfc" id="L307" title="All 2 branches covered.">		for (int i = 0; i &lt; axes.length; i++) {</span>
<span class="fc" id="L308">			Exp exp = axes[i].getExp();</span>
<span class="fc" id="L309">			iAxis = i;</span>
<span class="fc" id="L310">			walkTreeForParams(exp, iAxis);</span>
		}

<span class="fc" id="L313">	}</span>

	/**
	 * Collect Parameters and Parameter references in a subtree below (and
	 * including) exp visitor ???
	 */
	private void walkTreeForParams(Exp exp, int iAxis) throws PivotException {
<span class="fc bfc" id="L320" title="All 2 branches covered.">		if (!(exp instanceof FunCall))</span>
<span class="fc" id="L321">			return;</span>
<span class="fc" id="L322">		FunCall f = (FunCall) exp;</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">		if (f.isCallTo(&quot;Parameter&quot;)) {</span>
<span class="nc" id="L324">			int nArgs = f.getArgs().length;</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">			if (nArgs != 3 &amp;&amp; nArgs != 4) {</span>
<span class="nc" id="L326">				throw new PivotException(</span>
<span class="nc" id="L327">						&quot;Syntax Error in Parameter: wrong number of arguments&quot;);</span>
			}
<span class="nc bnc" id="L329" title="All 2 branches missed.">			if (!(f.getArgs()[0] instanceof Literal)) {</span>
<span class="nc" id="L330">				throw new PivotException(</span>
<span class="nc" id="L331">						&quot;Syntax Error in Parameter definition - 1.argument&quot;);</span>
			}

<span class="nc" id="L334">			Literal eName = (Literal) f.getArgs()[0];</span>
<span class="nc" id="L335">			String paraName = eName.stringValue();</span>
			// Found a parameter
			// if it is already there, throw an error
<span class="nc bnc" id="L338" title="All 2 branches missed.">			if (paraMap.containsKey(paraName.toUpperCase())) {</span>
				// already there, error
<span class="nc" id="L340">				String err = &quot;Parameter defined more than once:&quot; + paraName;</span>
<span class="nc" id="L341">				logger.error(err);</span>
<span class="nc" id="L342">				throw new PivotException(err);</span>
			} else {
				// analyze and add the Parameter
				int type;
<span class="nc" id="L346">				Object value = null;</span>
<span class="nc" id="L347">				f.pQuery = this;</span>
				// second Parameter must be ID, either a hierarchy or NUMERIC or
				// STRING
<span class="nc" id="L350">				CompoundId id = (CompoundId) f.getArgs()[1];</span>
<span class="nc" id="L351">				String[] ids = id.toStringArray();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">				if (ids.length &gt; 1) {</span>
					// error, must be NUMERIC or STRING or name of an hierarchy
<span class="nc" id="L354">					throw new PivotException(</span>
<span class="nc" id="L355">							&quot;Syntax Error in Parameter definition - 2.argument&quot;);</span>
				}
<span class="nc bnc" id="L357" title="All 2 branches missed.">				if (ids[0].equalsIgnoreCase(&quot;NUMERIC&quot;)) {</span>
<span class="nc" id="L358">					type = Parameter.TYPE_NUMERIC;</span>
					// 3.argument (value) is literal
<span class="nc bnc" id="L360" title="All 2 branches missed.">					if (!(f.getArgs()[0] instanceof Literal)) {</span>
<span class="nc" id="L361">						throw new PivotException(</span>
<span class="nc" id="L362">								&quot;Syntax Error in Parameter definition - 3.argument&quot;);</span>
					}
<span class="nc" id="L364">					Literal val = (Literal) f.getArgs()[2];</span>
<span class="nc" id="L365">					value = val.getValueObject();</span>

<span class="nc bnc" id="L367" title="All 2 branches missed.">				} else if (ids[0].equalsIgnoreCase(&quot;STRING&quot;)) {</span>
<span class="nc" id="L368">					type = Parameter.TYPE_STRING;</span>
<span class="nc" id="L369">					Literal val = (Literal) f.getArgs()[2];</span>
<span class="nc" id="L370">					value = val.getValueObject();</span>
				} else {
					// hierarchy expected
<span class="nc" id="L373">					type = Parameter.TYPE_MEMBER;</span>
<span class="nc" id="L374">					CompoundId val = (CompoundId) f.getArgs()[2];</span>
<span class="nc" id="L375">					value = val.toMdx(); // member String</span>
				}
<span class="nc" id="L377">				Parameter par = new Parameter(paraName, type, iAxis);</span>
<span class="nc" id="L378">				par.setOValue((Serializable) value);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">				if (nArgs == 4) {</span>
					// set description
<span class="nc" id="L381">					Literal desc = (Literal) f.getArgs()[3];</span>
<span class="nc" id="L382">					String description = (String) desc.getValueObject();</span>
<span class="nc" id="L383">					par.setDescription(description);</span>
				}
<span class="nc" id="L385">				paraMap.put(paraName.toUpperCase(), par);</span>
			}
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">		} else if (f.isCallTo(&quot;ParamRef&quot;)) {</span>
<span class="nc" id="L388">			f.pQuery = this;</span>
		}

		// recurse down on params
<span class="fc bfc" id="L392" title="All 2 branches covered.">		for (int i = 0; i &lt; f.getArgs().length; i++) {</span>
<span class="fc" id="L393">			walkTreeForParams(f.getArgs()[i], iAxis);</span>
		}

<span class="fc" id="L396">	}</span>

	/**
	 * @return parameter map
	 */
	public Map&lt;String, Parameter&gt; getParaMap() {
<span class="nc" id="L402">		return paraMap;</span>
	}

	/**
	 * add a formula for a member
	 */
	public void addFormula(String[] names, Exp exp,
			MemberProperty[] memberProperties) {
<span class="nc" id="L410">		Formula newFormula = new Formula(names, exp, memberProperties);</span>
<span class="nc" id="L411">		formulas.add(newFormula);</span>
<span class="nc" id="L412">	}</span>

	/**
	 * add a formula for a set
	 */
	public void addFormula(String[] names, Exp exp) {
<span class="nc" id="L418">		Formula newFormula = new Formula(names, exp);</span>
<span class="nc" id="L419">		formulas.add(newFormula);</span>
<span class="nc" id="L420">	}</span>

	/**
	 * remove a formula
	 */
	public void removeFormula(String uniqueName) {
<span class="nc bnc" id="L426" title="All 2 branches missed.">		for (Iterator&lt;Formula&gt; iter = formulas.iterator(); iter.hasNext();) {</span>
<span class="nc" id="L427">			Formula formula = iter.next();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">			if (uniqueName.equals(formula.getUniqeName()))</span>
<span class="nc" id="L429">				iter.remove();</span>
		}
<span class="nc" id="L431">	}</span>

	/**
	 * @see com.tonbeller.jpivot.olap.mdxparse.Exp#accept
	 */
	public void accept(ExpVisitor visitor) {
<span class="nc" id="L437">		visitor.visitParsedQuery(this);</span>
<span class="nc" id="L438">	}</span>

	/**
	 * @return
	 */
	public List&lt;CompoundId&gt; getCellProps() {
<span class="nc" id="L444">		return cellProps;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.10.201208310627</span></div></body></html>