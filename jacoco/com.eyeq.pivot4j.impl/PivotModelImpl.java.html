<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PivotModelImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Pivot4J</a> &gt; <a href="index.html" class="el_package">com.eyeq.pivot4j.impl</a> &gt; <span class="el_source">PivotModelImpl.java</span></div><h1>PivotModelImpl.java</h1><pre class="source lang-java linenums"><span class="fc" id="L1">/*</span>
 * ====================================================================
 * This software is subject to the terms of the Common Public License
 * Agreement, available at the following URL:
 *   http://www.opensource.org/licenses/cpl.html .
 * You must accept the terms of that agreement to use this software.
 * ====================================================================
 */
package com.eyeq.pivot4j.impl;

import java.io.Serializable;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Locale;

import org.olap4j.CellSet;
import org.olap4j.CellSetAxis;
import org.olap4j.OlapConnection;
import org.olap4j.OlapDataSource;
import org.olap4j.OlapException;
import org.olap4j.OlapStatement;
import org.olap4j.Position;
import org.olap4j.mdx.IdentifierNode;
import org.olap4j.mdx.parser.MdxParser;
import org.olap4j.mdx.parser.MdxParserFactory;
import org.olap4j.metadata.Catalog;
import org.olap4j.metadata.Cube;
import org.olap4j.metadata.Dimension;
import org.olap4j.metadata.Dimension.Type;
import org.olap4j.metadata.Member;
import org.olap4j.metadata.Schema;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.eyeq.pivot4j.ModelChangeEvent;
import com.eyeq.pivot4j.ModelChangeListener;
import com.eyeq.pivot4j.NotInitializedException;
import com.eyeq.pivot4j.PivotException;
import com.eyeq.pivot4j.PivotModel;
import com.eyeq.pivot4j.SortMode;
import com.eyeq.pivot4j.StateHolder;
import com.eyeq.pivot4j.query.Quax;
import com.eyeq.pivot4j.query.QueryAdapter;
import com.eyeq.pivot4j.query.QueryChangeEvent;
import com.eyeq.pivot4j.query.QueryChangeListener;
import com.eyeq.pivot4j.transform.Transform;
import com.eyeq.pivot4j.transform.TransformFactory;

/**
 * The pivot model represents all (meta-)data for an MDX query.
 */
<span class="fc" id="L55">public class PivotModelImpl implements PivotModel, StateHolder {</span>

<span class="fc" id="L57">	protected static Logger logger = LoggerFactory</span>
<span class="fc" id="L58">			.getLogger(PivotModelImpl.class);</span>

	private OlapDataSource dataSource;

	private OlapConnection connection;

	private String schemaName;

	private String cubeName;

	private String roleName;

	private Locale locale;

<span class="fc" id="L72">	private boolean initialized = false;</span>

<span class="fc" id="L74">	private Collection&lt;ModelChangeListener&gt; listeners = new ArrayList&lt;ModelChangeListener&gt;();</span>

	private QueryAdapter queryAdapter;

	private TransformFactory transformFactory;

<span class="fc" id="L80">	private int topBottomCount = 10;</span>

<span class="fc" id="L82">	private SortMode sortMode = SortMode.ASC;</span>

<span class="fc" id="L84">	private boolean sorting = false;</span>

	private List&lt;Member&gt; sortPosMembers;

	private String mdxQuery;

	private CellSet cellSet;

<span class="fc" id="L92">	private QueryChangeListener queryChangeListener = new QueryChangeListener() {</span>

		public void queryChanged(QueryChangeEvent e) {
<span class="fc" id="L95">			fireModelChanged();</span>
<span class="fc" id="L96">		}</span>
	};

	/**
	 * @param dataSource
	 * @param transformFactory
	 */
<span class="fc" id="L103">	public PivotModelImpl(OlapDataSource dataSource,</span>
			TransformFactory transformFactory) {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		if (dataSource == null) {</span>
<span class="nc" id="L106">			throw new IllegalArgumentException(</span>
<span class="nc" id="L107">					&quot;Missing required argument 'dataSource'.&quot;);</span>
		}

<span class="pc bpc" id="L110" title="1 of 2 branches missed.">		if (transformFactory == null) {</span>
<span class="nc" id="L111">			throw new IllegalArgumentException(</span>
<span class="nc" id="L112">					&quot;Missing required argument 'transformFactory'.&quot;);</span>
		}

<span class="fc" id="L115">		this.dataSource = dataSource;</span>
<span class="fc" id="L116">		this.transformFactory = transformFactory;</span>
<span class="fc" id="L117">	}</span>

	/**
	 * Returns the current locale.
	 * 
	 * @return Locale
	 * @see com.eyeq.pivot4j.PivotModel#getLocale()
	 */
	public Locale getLocale() {
<span class="nc bnc" id="L126" title="All 2 branches missed.">		if (locale == null) {</span>
<span class="nc" id="L127">			return Locale.getDefault();</span>
		}
<span class="nc" id="L129">		return locale;</span>
	}

	/**
	 * Sets the current locale.
	 * 
	 * @param locale
	 *            The locale to set
	 * @see com.eyeq.pivot4j.PivotModel#setLocale(java.util.Locale)
	 */
	public void setLocale(Locale locale) {
<span class="nc" id="L140">		this.locale = locale;</span>
<span class="nc" id="L141">	}</span>

	/**
	 * @return the roleName
	 * @see com.eyeq.pivot4j.PivotModel#getRoleName()
	 */
	public String getRoleName() {
<span class="nc" id="L148">		return roleName;</span>
	}

	/**
	 * @param roleName
	 *            the roleName to set
	 * @see com.eyeq.pivot4j.PivotModel#setRoleName(java.lang.String)
	 */
	public void setRoleName(String roleName) {
<span class="nc" id="L157">		this.roleName = roleName;</span>
<span class="nc" id="L158">	}</span>

	/**
	 * @see com.eyeq.pivot4j.PivotModel#initialize()
	 */
	public synchronized void initialize() {
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">		if (isInitialized()) {</span>
<span class="nc" id="L165">			destroy();</span>
		}

<span class="fc bfc" id="L168" title="All 2 branches covered.">		if (mdxQuery == null) {</span>
<span class="fc" id="L169">			throw new PivotException(&quot;Initial MDX query is null.&quot;);</span>
		}

		try {
<span class="fc" id="L173">			this.connection = createConnection(dataSource);</span>
<span class="nc" id="L174">		} catch (SQLException e) {</span>
<span class="nc" id="L175">			throw new PivotException(e);</span>
		}

<span class="fc" id="L178">		this.queryAdapter = createQueryAdapter();</span>
<span class="fc" id="L179">		queryAdapter.updateQuery();</span>

<span class="fc" id="L181">		queryAdapter.addChangeListener(queryChangeListener);</span>

<span class="fc" id="L183">		this.initialized = true;</span>

<span class="fc" id="L185">		fireModelInitialized();</span>
<span class="fc" id="L186">	}</span>

	/**
	 * @param dataSource
	 * @return
	 * @throws SQLException
	 */
	protected OlapConnection createConnection(OlapDataSource dataSource)
			throws SQLException {
<span class="fc" id="L195">		OlapConnection connection = dataSource.getConnection();</span>

<span class="pc bpc" id="L197" title="1 of 2 branches missed.">		if (roleName != null) {</span>
<span class="nc" id="L198">			connection.setRoleName(roleName);</span>
		}

<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if (locale != null) {</span>
<span class="nc" id="L202">			connection.setLocale(locale);</span>
		}

<span class="fc" id="L205">		return connection;</span>
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#isInitialized()
	 */
	public boolean isInitialized() {
<span class="fc" id="L212">		return initialized;</span>
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#destroy()
	 */
	public synchronized void destroy() throws NotInitializedException {
<span class="fc" id="L219">		checkInitialization();</span>

<span class="pc bpc" id="L221" title="1 of 2 branches missed.">		if (queryAdapter != null) {</span>
<span class="fc" id="L222">			queryAdapter.removeChangeListener(queryChangeListener);</span>
<span class="fc" id="L223">			this.queryAdapter = null;</span>
		}

<span class="pc bpc" id="L226" title="1 of 2 branches missed.">		if (connection != null) {</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">			if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L228">				logger.debug(&quot;Closing OLAP connection &quot; + connection);</span>
			}

			try {
<span class="fc" id="L232">				closeConnection(connection);</span>
<span class="nc" id="L233">			} catch (SQLException e) {</span>
<span class="nc" id="L234">				throw new PivotException(e);</span>
			}

<span class="fc" id="L237">			this.connection = null;</span>
		}

<span class="fc" id="L240">		this.cubeName = null;</span>
<span class="fc" id="L241">		this.schemaName = null;</span>
<span class="fc" id="L242">		this.sortPosMembers = null;</span>
<span class="fc" id="L243">		this.sortMode = SortMode.ASC;</span>
<span class="fc" id="L244">		this.sorting = false;</span>
<span class="fc" id="L245">		this.cellSet = null;</span>
<span class="fc" id="L246">		this.initialized = false;</span>

<span class="fc" id="L248">		fireModelDestroyed();</span>
<span class="fc" id="L249">	}</span>

	/**
	 * @param dataSource
	 * @return
	 * @throws SQLException
	 */
	protected void closeConnection(OlapConnection connection)
			throws SQLException {
<span class="fc" id="L258">		connection.close();</span>
<span class="fc" id="L259">	}</span>

	private void checkInitialization() throws NotInitializedException {
<span class="fc bfc" id="L262" title="All 2 branches covered.">		if (!isInitialized()) {</span>
<span class="fc" id="L263">			throw new NotInitializedException(</span>
<span class="fc" id="L264">					&quot;Model has not been initialized yet.&quot;);</span>
		}
<span class="fc" id="L266">	}</span>

	/**
	 * Returns the connection.
	 */
	protected OlapConnection getConnection() {
<span class="fc" id="L272">		return connection;</span>
	}

	public OlapDataSource getDataSource() {
<span class="nc" id="L276">		return dataSource;</span>
	}

	/**
	 * @return the schemaName
	 */
	protected String getSchemaName() {
<span class="nc" id="L283">		return schemaName;</span>
	}

	/**
	 * @return the cubeName
	 */
	protected String getCubeName() {
<span class="nc" id="L290">		return cubeName;</span>
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#getCatalog()
	 */
	public Catalog getCatalog() throws NotInitializedException {
<span class="nc" id="L297">		checkInitialization();</span>

		try {
<span class="nc" id="L300">			return connection.getOlapCatalog();</span>
<span class="nc" id="L301">		} catch (OlapException e) {</span>
<span class="nc" id="L302">			throw new PivotException(e);</span>
		}
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#getCube()
	 */
	public Cube getCube() throws NotInitializedException {
		try {
<span class="fc" id="L311">			return getCellSet().getMetaData().getCube();</span>
<span class="nc" id="L312">		} catch (OlapException e) {</span>
<span class="nc" id="L313">			throw new PivotException(e);</span>
		}
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#getCellSet()
	 */
	public synchronized CellSet getCellSet() throws NotInitializedException {
<span class="fc" id="L321">		checkInitialization();</span>

<span class="pc bpc" id="L323" title="1 of 2 branches missed.">		if (cellSet != null) {</span>
<span class="nc" id="L324">			return cellSet;</span>
		}

<span class="fc" id="L327">		long t1 = System.currentTimeMillis();</span>

<span class="pc bpc" id="L329" title="1 of 2 branches missed.">		if (queryAdapter == null) {</span>
<span class="nc" id="L330">			throw new IllegalStateException(&quot;Initial MDX is not specified.&quot;);</span>
		}

<span class="fc" id="L333">		String mdx = normalizeMdx(getCurrentMdx());</span>

<span class="pc bpc" id="L335" title="1 of 2 branches missed.">		if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L336">			logger.debug(mdx);</span>
		}

		try {
<span class="fc" id="L340">			this.cellSet = executeMdx(connection, mdx);</span>

<span class="fc" id="L342">			Cube cube = cellSet.getMetaData().getCube();</span>

<span class="fc" id="L344">			this.cubeName = cube.getName();</span>
<span class="fc" id="L345">			this.schemaName = cube.getSchema().getName();</span>
<span class="nc" id="L346">		} catch (OlapException e) {</span>
<span class="nc" id="L347">			throw new PivotException(e);</span>
		}

<span class="fc" id="L350">		queryAdapter.afterExecute(cellSet);</span>

<span class="pc bpc" id="L352" title="1 of 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="fc" id="L353">			long t2 = System.currentTimeMillis();</span>
<span class="fc" id="L354">			logger.info(&quot;Query execution time &quot; + (t2 - t1) + &quot; ms&quot;);</span>
		}

<span class="fc" id="L357">		return cellSet;</span>
	}

	/**
	 * @param connection
	 * @param mdx
	 * @return
	 * @throws OlapException
	 */
	protected CellSet executeMdx(OlapConnection connection, String mdx)
			throws OlapException {
<span class="fc" id="L368">		OlapStatement stmt = connection.createStatement();</span>
<span class="fc" id="L369">		return stmt.executeOlapQuery(mdx);</span>
	}

	protected String normalizeMdx(String mdx) {
<span class="fc bfc" id="L373" title="All 2 branches covered.">		if (mdx == null) {</span>
<span class="fc" id="L374">			return null;</span>
		} else {
<span class="fc" id="L376">			return mdx.replaceAll(&quot;\r&quot;, &quot;&quot;);</span>
		}
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#getCurrentMdx()
	 */
	public String getCurrentMdx() {
<span class="fc bfc" id="L384" title="All 2 branches covered.">		if (queryAdapter == null) {</span>
<span class="fc" id="L385">			return null;</span>
		} else {
<span class="fc" id="L387">			return queryAdapter.getCurrentMdx();</span>
		}
	}

	/**
	 * Returns the mdxQuery.
	 * 
	 * @return String
	 */
	public String getMdx() {
<span class="fc" id="L397">		return mdxQuery;</span>
	}

	/**
	 * Sets the mdxQuery.
	 * 
	 * @param mdxQuery
	 *            The mdxQuery to set
	 */
	public void setMdx(String mdxQuery) {
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		if (mdxQuery == null) {</span>
<span class="nc" id="L408">			throw new IllegalArgumentException(&quot;MDX query cannot be null.&quot;);</span>
		}

<span class="fc" id="L411">		this.mdxQuery = mdxQuery;</span>

<span class="fc" id="L413">		String mdx = normalizeMdx(mdxQuery);</span>
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">		if (!mdx.equals(normalizeMdx(getCurrentMdx()))) {</span>
<span class="fc" id="L415">			onMdxChanged(mdx);</span>
		}
<span class="fc" id="L417">	}</span>

	protected void onMdxChanged(String mdx) {
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="fc" id="L421">			logger.info(&quot;setMdx: &quot; + mdx);</span>
		}

<span class="fc" id="L424">		this.cellSet = null;</span>
<span class="fc" id="L425">		this.topBottomCount = 10;</span>
<span class="fc" id="L426">		this.sortMode = SortMode.ASC;</span>
<span class="fc" id="L427">		this.sorting = false;</span>
<span class="fc" id="L428">		this.sortPosMembers = null;</span>

<span class="pc bpc" id="L430" title="1 of 2 branches missed.">		if (queryAdapter != null) {</span>
<span class="nc" id="L431">			queryAdapter.removeChangeListener(queryChangeListener);</span>
<span class="nc" id="L432">			queryAdapter = null;</span>
		}

<span class="pc bpc" id="L435" title="1 of 2 branches missed.">		if (isInitialized()) {</span>
<span class="nc" id="L436">			this.queryAdapter = createQueryAdapter();</span>
<span class="nc" id="L437">			queryAdapter.updateQuery();</span>

<span class="nc" id="L439">			queryAdapter.addChangeListener(queryChangeListener);</span>
		}
<span class="fc" id="L441">	}</span>

	protected QueryAdapter createQueryAdapter() {
<span class="fc" id="L444">		MdxParserFactory factory = getConnection().getParserFactory();</span>
<span class="fc" id="L445">		MdxParser parser = factory.createMdxParser(connection);</span>

<span class="fc" id="L447">		return new QueryAdapter(this, parser);</span>
	}

	/**
	 * Returns the queryAdapter.
	 * 
	 * @return QueryAdapter
	 */
	protected QueryAdapter getQueryAdapter() {
<span class="nc" id="L456">		return queryAdapter;</span>
	}

	/**
	 * @see com.eyeq.pivot4j.tonbeller.jpivot.core.Model#addModelChangeListener(ModelChangeListener)
	 */
	public void addModelChangeListener(ModelChangeListener listener) {
<span class="nc" id="L463">		listeners.add(listener);</span>
<span class="nc" id="L464">	}</span>

	/**
	 * @see com.eyeq.pivot4j.tonbeller.jpivot.core.Model#removeModelChangeListener(ModelChangeListener)
	 */
	public void removeModelChangeListener(ModelChangeListener listener) {
<span class="nc" id="L470">		listeners.remove(listener);</span>
<span class="nc" id="L471">	}</span>

	protected void fireModelInitialized() {
<span class="fc" id="L474">		ModelChangeEvent e = new ModelChangeEvent(this);</span>
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">		for (ModelChangeListener listener : listeners) {</span>
<span class="nc" id="L476">			listener.modelInitialized(e);</span>
		}
<span class="fc" id="L478">	}</span>

	protected void fireModelChanged() {
<span class="fc" id="L481">		this.cellSet = null;</span>

<span class="fc" id="L483">		ModelChangeEvent e = new ModelChangeEvent(this);</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">		for (ModelChangeListener listener : listeners) {</span>
<span class="nc" id="L485">			listener.modelChanged(e);</span>
		}
<span class="fc" id="L487">	}</span>

	protected void fireStructureChanged() {
<span class="nc" id="L490">		this.cellSet = null;</span>

<span class="nc" id="L492">		ModelChangeEvent e = new ModelChangeEvent(this);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">		for (ModelChangeListener listener : listeners) {</span>
<span class="nc" id="L494">			listener.structureChanged(e);</span>
		}
<span class="nc" id="L496">	}</span>

	protected void fireModelDestroyed() {
<span class="fc" id="L499">		ModelChangeEvent e = new ModelChangeEvent(this);</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">		for (ModelChangeListener listener : listeners) {</span>
<span class="nc" id="L501">			listener.modelDestroyed(e);</span>
		}
<span class="fc" id="L503">	}</span>

	/**
	 * @see com.eyeq.pivot4j.PivotModel#getTransform(java.lang.Class)
	 */
	public &lt;T extends Transform&gt; T getTransform(Class&lt;T&gt; type) {
<span class="fc" id="L509">		return transformFactory.createTransform(type, queryAdapter);</span>
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#isSorting()
	 */
	public boolean isSorting() {
<span class="fc" id="L516">		return sorting;</span>
	}

	/**
	 * @param position
	 *            to be checked
	 * @return true, if position is the current sorting position
	 * @see com.eyeq.pivot4j.PivotModel#isSorting(org.olap4j.Position)
	 */
	public boolean isSorting(Position position) {
<span class="nc bnc" id="L526" title="All 2 branches missed.">		if (!isSortOnQuery()) {</span>
<span class="nc" id="L527">			return false;</span>
		} else {
<span class="nc bnc" id="L529" title="All 2 branches missed.">			if (sortPosMembers.size() != position.getMembers().size()) {</span>
<span class="nc" id="L530">				return false;</span>
			}

<span class="nc bnc" id="L533" title="All 2 branches missed.">			for (int i = 0; i &lt; sortPosMembers.size(); i++) {</span>
<span class="nc" id="L534">				Member member1 = sortPosMembers.get(i);</span>
<span class="nc" id="L535">				Member member2 = position.getMembers().get(i);</span>
				// any null does not compare
<span class="nc bnc" id="L537" title="All 2 branches missed.">				if (member1 == null) {</span>
<span class="nc" id="L538">					return false;</span>
<span class="nc bnc" id="L539" title="All 2 branches missed.">				} else if (!member1.equals(member2)) {</span>
<span class="nc" id="L540">					return false;</span>
				}
			}
<span class="nc" id="L543">			return true;</span>
		}
	}

	/**
	 * @task support for natural sorting
	 * @see com.eyeq.pivot4j.PivotModel#setSorting(boolean)
	 */
	public void setSorting(boolean sorting) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">		if (sorting == this.sorting) {</span>
<span class="nc" id="L553">			return;</span>
		}

<span class="nc bnc" id="L556" title="All 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L557">			logger.info(&quot;change sorting to &quot; + sorting);</span>
		}

<span class="nc" id="L560">		this.sorting = sorting;</span>

<span class="nc" id="L562">		fireModelChanged();</span>
<span class="nc" id="L563">	}</span>

	/**
	 * @return sort mode (ASC,DESC,BASC,BDESC,TOPCOUNT,BOTTOMCOUNT)
	 */
	public SortMode getSortMode() {
<span class="nc" id="L569">		return sortMode;</span>
	}

	/**
	 * @param sort
	 *            mode (ASC,DESC,BASC,BDESC)
	 */
	public void setSortMode(SortMode sortMode) {
<span class="nc bnc" id="L577" title="All 2 branches missed.">		if (this.sortMode == sortMode) {</span>
<span class="nc" id="L578">			return;</span>
		}

<span class="nc bnc" id="L581" title="All 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L582">			logger.info(&quot;change topBottomCount from &quot; + this.sortMode + &quot; to &quot;</span>
<span class="nc" id="L583">					+ sortMode);</span>
		}

<span class="nc" id="L586">		this.sortMode = sortMode;</span>

<span class="nc bnc" id="L588" title="All 2 branches missed.">		if (isSortOnQuery()) {</span>
<span class="nc" id="L589">			fireModelChanged();</span>
		}
<span class="nc" id="L591">	}</span>

	/**
	 * returns true, if one of the members is a measure
	 * 
	 * @param position
	 *            the position to check for sortability
	 * @return true, if the position is sortable
	 */
	public boolean isSortable(Position position) {
		try {
<span class="nc" id="L602">			List&lt;Member&gt; members = position.getMembers();</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">			for (Member member : members) {</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">				if (member.getLevel().getHierarchy().getDimension()</span>
<span class="nc" id="L605">						.getDimensionType() == Type.MEASURE) {</span>
<span class="nc" id="L606">					return true;</span>
				}
			}
<span class="nc" id="L609">		} catch (OlapException e) {</span>
<span class="nc" id="L610">			throw new PivotException(e);</span>
		}

<span class="nc" id="L613">		return false;</span>
	}

	/**
	 * @return true, if there is a sort for the query
	 */
	protected boolean isSortOnQuery() {
<span class="nc bnc" id="L620" title="All 6 branches missed.">		return sorting &amp;&amp; sortPosMembers != null &amp;&amp; !sortPosMembers.isEmpty();</span>
	}

	/**
	 * @see com.eyeq.pivot4j.PivotModel#getSortPosMembers()
	 */
	public List&lt;Member&gt; getSortPosMembers() {
<span class="nc" id="L627">		return Collections.unmodifiableList(sortPosMembers);</span>
	}

	/**
	 * @return top/bottom count
	 */
	public int getTopBottomCount() {
<span class="nc" id="L634">		return topBottomCount;</span>
	}

	/**
	 * @param top
	 *            /bottom count
	 */
	public void setTopBottomCount(int topBottomCount) {
<span class="nc bnc" id="L642" title="All 2 branches missed.">		if (this.topBottomCount == topBottomCount) {</span>
<span class="nc" id="L643">			return;</span>
		}

<span class="nc bnc" id="L646" title="All 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L647">			logger.info(&quot;Change topBottomCount from &quot; + this.topBottomCount</span>
<span class="nc" id="L648">					+ &quot; to &quot; + topBottomCount);</span>
		}

<span class="nc" id="L651">		this.topBottomCount = topBottomCount;</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">		if (sorting</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">				&amp;&amp; sortPosMembers != null</span>
<span class="nc bnc" id="L655" title="All 4 branches missed.">				&amp;&amp; (sortMode == SortMode.TOPCOUNT || sortMode == SortMode.BOTTOMCOUNT)) {</span>
<span class="nc" id="L656">			fireModelChanged();</span>
		}
<span class="nc" id="L658">	}</span>

	/**
	 * @param membersToSort
	 *            Axis containing the members to be sorted
	 * @param position
	 *            Position on &quot;other axis&quot; defining the members by which the
	 *            membersToSort are sorted
	 */
	public void sort(CellSetAxis membersToSort, Position position) {
<span class="nc" id="L668">		List&lt;Position&gt; positions = membersToSort.getPositions();</span>

		// if the axis to sort does not contain any positions - sorting is not
		// posssible
<span class="nc bnc" id="L672" title="All 2 branches missed.">		if (positions.isEmpty()) {</span>
<span class="nc bnc" id="L673" title="All 2 branches missed.">			if (logger.isWarnEnabled()) {</span>
<span class="nc" id="L674">				logger.warn(&quot;Reject sort, the axis to be sorted is empty.&quot;);</span>
			}

<span class="nc" id="L677">			this.sorting = false;</span>
<span class="nc" id="L678">			return;</span>
		}

<span class="nc" id="L681">		this.sortPosMembers = position.getMembers();</span>

		// find the axis to sort
<span class="nc" id="L684">		Dimension dim = positions.get(0).getMembers().get(0).getDimension();</span>

<span class="nc" id="L686">		Quax quaxToSort = getQueryAdapter().findQuax(dim);</span>

<span class="nc bnc" id="L688" title="All 2 branches missed.">		if (quaxToSort == null) {</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">			if (logger.isWarnEnabled()) {</span>
<span class="nc" id="L690">				logger.warn(&quot;Reject sort, the Quax is null&quot;);</span>
			}
<span class="nc" id="L692">			this.sorting = false;</span>
<span class="nc" id="L693">			return;</span>
		}

<span class="nc" id="L696">		getQueryAdapter().setQuaxToSort(quaxToSort);</span>

<span class="nc bnc" id="L698" title="All 2 branches missed.">		if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L699">			StringBuilder builder = new StringBuilder();</span>
<span class="nc" id="L700">			builder.append(&quot;Change Sort Position &quot;);</span>

<span class="nc" id="L702">			boolean first = true;</span>

<span class="nc" id="L704">			List&lt;Member&gt; members = position.getMembers();</span>
<span class="nc bnc" id="L705" title="All 2 branches missed.">			for (Member member : members) {</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">				if (first) {</span>
<span class="nc" id="L707">					first = false;</span>
				} else {
<span class="nc" id="L709">					builder.append(&quot; &quot;);</span>
				}
<span class="nc" id="L711">				builder.append(member.getUniqueName());</span>
			}
<span class="nc" id="L713">			builder.append(&quot; iAxisToSort=&quot;);</span>
<span class="nc" id="L714">			builder.append(Integer.toString(quaxToSort.getOrdinal()));</span>

<span class="nc" id="L716">			logger.info(builder.toString());</span>
		}

<span class="nc" id="L719">		fireModelChanged();</span>
<span class="nc" id="L720">	}</span>

	/**
	 * @see com.eyeq.pivot4j.StateHolder#bookmarkState()
	 */
	public synchronized Serializable bookmarkState() {
<span class="nc" id="L726">		Serializable[] state = new Serializable[5];</span>

<span class="nc" id="L728">		state[0] = getCurrentMdx();</span>
<span class="nc" id="L729">		state[1] = cubeName;</span>
<span class="nc" id="L730">		state[2] = schemaName;</span>

<span class="nc bnc" id="L732" title="All 2 branches missed.">		if (sortPosMembers == null) {</span>
<span class="nc" id="L733">			state[3] = null;</span>
		} else {
<span class="nc" id="L735">			Serializable[] sortState = new Serializable[4];</span>

<span class="nc" id="L737">			String[] uniqueNames = new String[sortPosMembers.size()];</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">			for (int i = 0; i &lt; uniqueNames.length; i++) {</span>
<span class="nc" id="L739">				uniqueNames[i] = sortPosMembers.get(i).getUniqueName();</span>
			}

<span class="nc" id="L742">			sortState[0] = uniqueNames;</span>
<span class="nc" id="L743">			sortState[1] = getTopBottomCount();</span>
<span class="nc" id="L744">			sortState[2] = getSortMode();</span>
<span class="nc" id="L745">			sortState[3] = isSorting();</span>

<span class="nc" id="L747">			state[3] = sortState;</span>
		}

<span class="nc" id="L750">		state[4] = getQueryAdapter().bookmarkState();</span>

<span class="nc" id="L752">		return state;</span>
	}

	/**
	 * @see com.eyeq.pivot4j.StateHolder#restoreState(java.io.Serializable)
	 */
	public synchronized void restoreState(Serializable state) {
<span class="nc" id="L759">		Serializable[] states = (Serializable[]) state;</span>

<span class="nc" id="L761">		setMdx((String) states[0]);</span>

<span class="nc" id="L763">		this.cubeName = (String) states[1];</span>
<span class="nc" id="L764">		this.schemaName = (String) states[2];</span>

<span class="nc bnc" id="L766" title="All 2 branches missed.">		if (!isInitialized()) {</span>
<span class="nc" id="L767">			initialize();</span>
		}

		// sorting
<span class="nc bnc" id="L771" title="All 6 branches missed.">		if (states[3] == null || cubeName == null || schemaName == null) {</span>
<span class="nc" id="L772">			this.sortPosMembers = null;</span>
		} else {
			try {
<span class="nc" id="L775">				Schema schema = getCatalog().getSchemas().get(schemaName);</span>
<span class="nc" id="L776">				Cube cube = schema.getCubes().get(cubeName);</span>

<span class="nc" id="L778">				Serializable[] sortStates = (Serializable[]) states[3];</span>

<span class="nc" id="L780">				String[] sortPosUniqueNames = (String[]) sortStates[0];</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">				if (sortPosUniqueNames == null) {</span>
<span class="nc" id="L782">					this.sortPosMembers = null;</span>
				} else {
<span class="nc" id="L784">					this.sortPosMembers = new ArrayList&lt;Member&gt;(</span>
<span class="nc" id="L785">							sortPosUniqueNames.length);</span>

<span class="nc bnc" id="L787" title="All 2 branches missed.">					for (int i = 0; i &lt; sortPosUniqueNames.length; i++) {</span>
<span class="nc" id="L788">						Member member = cube.lookupMember(IdentifierNode</span>
<span class="nc" id="L789">								.parseIdentifier(sortPosUniqueNames[i])</span>
<span class="nc" id="L790">								.getSegmentList());</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">						if (member == null) {</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">							if (logger.isWarnEnabled()) {</span>
<span class="nc" id="L793">								logger.warn(&quot;sort position member not found &quot;</span>
<span class="nc" id="L794">										+ sortPosUniqueNames[i]);</span>
							}

<span class="nc" id="L797">							break;</span>
						}

<span class="nc" id="L800">						sortPosMembers.add(member);</span>
					}

<span class="nc" id="L803">					this.topBottomCount = (Integer) sortStates[1];</span>
<span class="nc" id="L804">					this.sortMode = (SortMode) sortStates[2];</span>
<span class="nc" id="L805">					this.sorting = (Boolean) sortStates[3];</span>
				}
<span class="nc" id="L807">			} catch (OlapException e) {</span>
<span class="nc" id="L808">				throw new PivotException(e);</span>
			}
		}

<span class="nc" id="L812">		this.cellSet = null;</span>

<span class="nc" id="L814">		queryAdapter.restoreState(states[4]);</span>
<span class="nc" id="L815">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.10.201208310627</span></div></body></html>