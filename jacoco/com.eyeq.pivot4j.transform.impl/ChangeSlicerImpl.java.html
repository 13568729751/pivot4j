<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ChangeSlicerImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Pivot4J</a> &gt; <a href="index.html" class="el_package">com.eyeq.pivot4j.transform.impl</a> &gt; <span class="el_source">ChangeSlicerImpl.java</span></div><h1>ChangeSlicerImpl.java</h1><pre class="source lang-java linenums">/*
 * ====================================================================
 * This software is subject to the terms of the Common Public License
 * Agreement, available at the following URL:
 *   http://www.opensource.org/licenses/cpl.html .
 * You must accept the terms of that agreement to use this software.
 * ====================================================================
 */
package com.eyeq.pivot4j.transform.impl;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import org.olap4j.CellSet;
import org.olap4j.CellSetAxis;
import org.olap4j.Position;
import org.olap4j.metadata.Member;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.eyeq.pivot4j.NotInitializedException;
import com.eyeq.pivot4j.mdx.Exp;
import com.eyeq.pivot4j.mdx.FunCall;
import com.eyeq.pivot4j.mdx.Syntax;
import com.eyeq.pivot4j.query.QuaxUtil;
import com.eyeq.pivot4j.query.QueryAdapter;
import com.eyeq.pivot4j.transform.AbstractTransform;
import com.eyeq.pivot4j.transform.ChangeSlicer;

<span class="fc" id="L31">public class ChangeSlicerImpl extends AbstractTransform implements ChangeSlicer {</span>

<span class="fc" id="L33">	protected static Logger logger = LoggerFactory</span>
<span class="fc" id="L34">			.getLogger(ChangeSlicerImpl.class);</span>

	/**
	 * @param queryAdapter
	 */
	public ChangeSlicerImpl(QueryAdapter queryAdapter) {
<span class="fc" id="L40">		super(queryAdapter);</span>
<span class="fc" id="L41">	}</span>

	/**
	 * @see com.eyeq.pivot4j.transform.ChangeSlicer#getSlicer()
	 */
	public List&lt;Member&gt; getSlicer() {
		// Use result rather than query
		CellSet cellSet;

		try {
<span class="fc" id="L51">			cellSet = getQueryAdapter().getModel().getCellSet();</span>
<span class="nc" id="L52">		} catch (NotInitializedException e) {</span>
<span class="nc" id="L53">			return Collections.emptyList();</span>
		}

<span class="fc" id="L56">		CellSetAxis slicer = cellSet.getFilterAxis();</span>

<span class="fc" id="L58">		List&lt;Position&gt; positions = slicer.getPositions();</span>
<span class="fc" id="L59">		List&lt;Member&gt; members = new ArrayList&lt;Member&gt;();</span>

<span class="fc bfc" id="L61" title="All 2 branches covered.">		for (Position position : positions) {</span>
<span class="fc" id="L62">			List&lt;Member&gt; posMembers = position.getMembers();</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">			for (Member posMember : posMembers) {</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">				if (!members.contains(posMember)) {</span>
<span class="fc" id="L65">					members.add(posMember);</span>
				}
			}
		}

<span class="fc" id="L70">		return members;</span>
	}

	/**
	 * @see com.eyeq.pivot4j.transform.ChangeSlicer#setSlicer(java.util.List)
	 */
	public void setSlicer(List&lt;Member&gt; members) {
<span class="fc" id="L77">		Exp slicerExp = null;</span>

<span class="pc bpc" id="L79" title="1 of 2 branches missed.">		if (members.isEmpty()) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">			if (logger.isInfoEnabled()) {</span>
<span class="nc" id="L81">				logger.info(&quot;Slicer set to null.&quot;);</span>
			}
		} else {
<span class="fc" id="L84">			List&lt;Exp&gt; collectedMemberExpressions = new ArrayList&lt;Exp&gt;();</span>
<span class="fc" id="L85">			List&lt;Exp&gt; conditions = new ArrayList&lt;Exp&gt;();</span>

<span class="fc" id="L87">			String hierarchyName = &quot;&quot;;</span>
<span class="fc" id="L88">			String prevHierarchyName = &quot;&quot;;</span>

<span class="fc" id="L90">			FunCall func = null;</span>

<span class="fc" id="L92">			boolean firstCondition = true;</span>

<span class="fc bfc" id="L94" title="All 2 branches covered.">			for (Member member : members) {</span>
<span class="fc" id="L95">				String uniqueName = member.getUniqueName();</span>

<span class="fc" id="L97">				hierarchyName = uniqueName</span>
<span class="fc" id="L98">						.substring(1, uniqueName.indexOf(&quot;]&quot;));</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">				if (!hierarchyName.equals(prevHierarchyName)) {</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">					if (!collectedMemberExpressions.isEmpty()) {</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">						if (firstCondition) {</span>
<span class="fc" id="L103">							func = new FunCall(</span>
<span class="fc" id="L104">									&quot;{}&quot;,</span>
<span class="fc" id="L105">									collectedMemberExpressions</span>
<span class="fc" id="L106">											.toArray(new Exp[collectedMemberExpressions</span>
<span class="fc" id="L107">													.size()]), Syntax.Braces);</span>
						} else {
<span class="nc" id="L109">							conditions</span>
<span class="nc" id="L110">									.add(new FunCall(</span>
<span class="nc" id="L111">											&quot;{}&quot;,</span>
<span class="nc" id="L112">											collectedMemberExpressions</span>
<span class="nc" id="L113">													.toArray(new Exp[collectedMemberExpressions</span>
<span class="nc" id="L114">															.size()]),</span>
<span class="nc" id="L115">											Syntax.Braces));</span>
<span class="nc" id="L116">							func = new FunCall(&quot;CrossJoin&quot;,</span>
<span class="nc" id="L117">									conditions.toArray(new Exp[conditions</span>
<span class="nc" id="L118">											.size()]), Syntax.Function);</span>
<span class="nc" id="L119">							conditions.clear();</span>
						}

<span class="fc" id="L122">						conditions.add(func);</span>
<span class="fc" id="L123">						firstCondition = false;</span>

<span class="pc bpc" id="L125" title="1 of 2 branches missed.">						if (logger.isInfoEnabled()) {</span>
<span class="fc" id="L126">							logger.info(&quot;Added a new filter condition for Hierarchy: &quot;</span>
<span class="fc" id="L127">									+ prevHierarchyName</span>
<span class="fc" id="L128">									+ &quot;, Conditions number: &quot;</span>
<span class="fc" id="L129">									+ collectedMemberExpressions.size());</span>
						}

<span class="fc" id="L132">						collectedMemberExpressions.clear();</span>

<span class="pc bpc" id="L134" title="1 of 2 branches missed.">						if (logger.isInfoEnabled()) {</span>
<span class="fc" id="L135">							logger.info(&quot;Clear conditions list. Size = &quot;</span>
<span class="fc" id="L136">									+ collectedMemberExpressions.size());</span>
						}
					}

<span class="fc" id="L140">					prevHierarchyName = hierarchyName;</span>

<span class="pc bpc" id="L142" title="1 of 2 branches missed.">					if (logger.isInfoEnabled()) {</span>
<span class="fc" id="L143">						logger.info(&quot;Collecting filters on member: &quot;</span>
<span class="fc" id="L144">								+ hierarchyName);</span>
					}
				}

<span class="fc" id="L148">				collectedMemberExpressions.add(QuaxUtil.expForMember(member));</span>
			}

			// Add lastly collected member to filters conditions list
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">			if (!collectedMemberExpressions.isEmpty()) {</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">				if (members.size() == 1) {</span>
<span class="fc" id="L154">					conditions.add(collectedMemberExpressions.get(0));</span>
				} else {
<span class="fc" id="L156">					conditions.add(new FunCall(&quot;{}&quot;,</span>
<span class="fc" id="L157">							collectedMemberExpressions</span>
<span class="fc" id="L158">									.toArray(new Exp[collectedMemberExpressions</span>
<span class="fc" id="L159">											.size()]), Syntax.Braces));</span>
				}

<span class="pc bpc" id="L162" title="1 of 2 branches missed.">				if (logger.isInfoEnabled()) {</span>
<span class="fc" id="L163">					logger.info(&quot;Added a new filter condition for Hierarchy: &quot;</span>
<span class="fc" id="L164">							+ hierarchyName);</span>
				}
			}

<span class="fc bfc" id="L168" title="All 2 branches covered.">			if (conditions.size() == 1) {</span>
<span class="fc" id="L169">				slicerExp = conditions.get(0);</span>
			} else {
				// SeraSoft - More dimensions selected. Build a CrossJoin
				// function
<span class="fc" id="L173">				FunCall intersectConditions = new FunCall(&quot;Crossjoin&quot;,</span>
<span class="fc" id="L174">						conditions.toArray(new Exp[conditions.size()]),</span>
<span class="fc" id="L175">						Syntax.Function);</span>

<span class="fc" id="L177">				slicerExp = intersectConditions;</span>
			}
		}

<span class="fc" id="L181">		getQueryAdapter().changeSlicer(slicerExp);</span>
<span class="fc" id="L182">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.5.10.201208310627</span></div></body></html>